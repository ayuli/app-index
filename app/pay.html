<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Author" contect="http://www.webqin.net">
    <title>三级分销</title>
    <link rel="shortcut icon" href="images/favicon.ico" />
    <link rel="stylesheet" href="css/mui.css">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet"> 
    <link href="css/response.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <style>
	  .mui-table-view{
		  position: static;
	  }
	  
  </style>
  <body>
    <div class="maincont">
     <header>
      <a href="javascript:history.back(-1)" class="back-off fl"><span class="glyphicon glyphicon-menu-left"></span></a>
      <div class="head-mid">
       <h1>购物车</h1>
      </div>
     </header>
     <div class="head-top">
      <img src="images/head.jpg" />
     </div><!--head-top/-->
     <div class="dingdanlist">
      <table>
       <tr>
        <td width="75%" colspan="3" style='border: none;' class='address'>
			<ul class="mui-table-view" style='background-color: #f2f2f2;'>  
				<li class="mui-table-view-cell mui-collapse address_info">
					<a class="mui-navigate-right" href="#" >选择收货地址</a>
					
				</li> 
				
			</ul> 
		</td>
        <!-- <td align="right"><img src="images/jian-new.png" /></td> -->
       </tr>
       <tr>
			<td colspan="3" style="height:10px; background:#efefef;padding:0;border:none;">
			</td> 
	   </tr>
       
       <tr>
        <td class="dingimg" width="100%" colspan="3">
			<ul class="mui-table-view" style='background-color: #f2f2f2;'>  
				<li class="mui-table-view-cell mui-collapse mui-active">
					<a class="mui-navigate-right" href="#" >选择支付方式</a>
					<div class='mui-collapse-content'>
						<p>
							<div class="mui-input-row mui-radio">
								<label>微信</label>
								<input name="pay_way" type="radio" checked="checked" value='1'>
							</div>
							<div class="mui-input-row mui-radio">
								<label>支付宝</label>
								<input name="pay_way" type="radio" value='2'>
							</div>
						</p>
					</div>
				</li>
				
			</ul>
		</td>
       </tr>
       <tr>
			<td colspan="3" style="height:10px; background:#efefef;padding:0;">
				 
				
			</td>
	   </tr>
       <tr>
        <td class="dingimg" width="100%" colspan="3">
			<ul class="mui-table-view" style='background-color: #f2f2f2;'>  
				<li class="mui-table-view-cell mui-collapse mui-active couponInfo">
					<a class="mui-navigate-right" href="#" >选择优惠券</a> 
						
				</li> 
				
			</ul> 
		</td>
       </tr> 
       <tr><td colspan="3" style="height:10px; background:#efefef;padding:0;"></td></tr>
       <!-- <tr>
        <td class="dingimg" width="75%" colspan="2">是否需要开发票</td>
        <td align="right"><a href="javascript:;" class="orange">是</a> &nbsp; <a href="javascript:;">否</a></td>
       </tr>
       <tr>
        <td class="dingimg" width="75%" colspan="2">发票抬头</td>
        <td align="right"><span class="hui">个人</span></td>
       </tr>
       <tr>
        <td class="dingimg" width="75%" colspan="2">发票内容</td>
        <td align="right"><a href="javascript:;" class="hui">请选择发票内容</a></td>
       </tr>
       <tr><td colspan="3" style="height:10px; background:#fff;padding:0;"></td></tr> -->
       <tr>
        <td class="dingimg goods_list" width="75%" colspan="3">商品清单</td>
       </tr>
       
      <!-- <tr>
        <td class="dingimg" width="15%"><img src="images/zf3.jpg" /></td>
        <td width="50%">
         <h3>三级分销农庄有机瓢瓜400g</h3>
         <time>下单时间：2015-08-11  13:51</time>
        </td>
        <td align="right"><span class="qingdan">X 1</span></td>
       </tr>
       <tr>
        <th colspan="3"><strong class="orange">¥36.60</strong></th>
       </tr>
       <tr>
        <td class="dingimg" width="15%"><img src="images/zf3.jpg" /></td>
        <td width="50%">
         <h3>三级分销农庄有机瓢瓜400g</h3>
         <time>下单时间：2015-08-11  13:51</time>
        </td>
        <td align="right"><span class="qingdan">X 1</span></td>
       </tr> -->
       <!-- <tr>
        <th colspan="3"><strong class="orange">¥36.60</strong></th>
       </tr> -->
       
       <tr>
        <td class="dingimg" width="75%" colspan="2">商品金额</td>
        <td align="right"><span style='color: #f60;'>¥</span><strong class="orange total_price">68.80</strong></td>
       </tr>
       
       <tr>
        <td class="dingimg" width="75%" colspan="2">抵扣金额</td>
        <td align="right"><span style="color: #7ABD54;">¥</span><strong class="green zhekou">0.00</strong></td>
       </tr>
       
      </table>
     </div><!--dingdanlist/-->
     
     
    </div><!--content/-->
    
    <div class="height1"></div>
    <div class="gwcpiao">
     <table>
      <tr>
       <th width="10%"><a href="javascript:;"><span class="glyphicon glyphicon-menu-left"></span></a></th>
       <td width="50%">总计：<span style='color: #f60;'>¥</span><strong class="orange foot_price">69.88</strong></td>
       <td width="40%"><a href="javascript:;" class="jiesuan">提交订单</a></td>
      </tr>
     </table>
    </div><!--gwcpiao/--> 
    </div><!--maincont-->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/style.js"></script>
    <!--jq加减-->
	<script src='js/mui.js'></script>
    <script src="js/jquery.spinner.js"></script>
   <script>
	$('.spinnerExample').spinner({});  
	</script>
  </body>
</html>
<script>
	$(function(){
		mui.plusReady(function () {
			var foot_price=0;
			var total_price=0;
			data = plus.webview.currentWebview();
			var cart_id = data.cart_id
			var user_id = plus.storage.getItem("uid"); 
			//获取用户地址
 			var url="http://39.96.199.148:8060/addressGet"; 
			$.get(url,{user_id:user_id},function(res){  
				if(res.code==0){     
					$(".address_info").addClass('none');
					$(".address").html("<div style='background-color: #f2f2f2;height:35px;'><span style='line-height:35px;margin-left:15px;' class='addaddress'>"+res.msg+"</span></div>");
					$(".addaddress").click(function(){  
						 mui.openWindow({
						 	url:'address.html', 
						 	createNew:true,
						 	extras:{ 
						 		cart_id:cart_id
						 	}
						 });
					});
				}else{
					var str="<div class='mui-collapse-content'><p>";
					$.each(res.data,function(i,v){
						if(v.is_address==1){
							str+="<div class='mui-input-row mui-radio'>"+  
									"<label>"+v.addressInfo+" "+v.userInfo+"</label>"+
									"<input name='address_id' checked    type='radio'  value='"+v.id+"'>"+
								"</div>";
						}else{ 
							str+="<div class='mui-input-row mui-radio'>"+  
									"<label>"+v.addressInfo+" "+v.userInfo+"</label>"+
									"<input name='address_id'     type='radio'  value='"+v.id+"'>"+
								"</div>";
						}
					})
					str+="</p></div>";
					$(".address_info").append(str);
				}
				
				
			},'json');  
			//获取用户选择的商品信息
			$.post("http://39.96.199.148:8060/cartshow",{cart_id:cart_id,user_id:user_id},function(res){
				if(res.code==1){ 
					var str="";  
					$.each(res.data,function(i,v){
						total_price+=Number(v.goods_price);  
						if(v.type_id!=null){
							str+="<tr class='goodsList'>"+ 
								"<td class='dingimg' width='15%'><img src='http://39.96.199.148:8060/"+v.goods_img+"' /></td>"+
								"<td width='50%'>"+
								"<h3>"+v.goods_name+" "+v.attr_value+"</h3>"+
								"</td>"+
								"<td align='right'><span class='qingdan'>X "+v.goods_num+"</span></td>"+
								"</tr>"+
								"<tr>"+
								"<th colspan='3'><strong class='orange goods_price'>¥"+v.goods_price+"</strong></th>"+
								"</tr>";
						}else{
							str+="<tr class='goodsList'>"+
								"<td class='dingimg' width='15%'><img src='http://39.96.199.148:8060/"+v.goods_img+"'   /></td>"+
								"<td width='50%'>"+
								"<h3>"+v.goods_name+"</h3>"+ 
								"</td>"+
								"<td align='right'><span class='qingdan'>X "+v.goods_num+"</span></td>"+
								"</tr>"+
								"<tr>"+ 
								"<th colspan='3'><strong class='orange goods_price'>¥"+v.goods_price+"</strong></th>"+
								"</tr>";
						}
						
					});
					total_price=total_price.toFixed(2);
					$(".goods_list").parent().after(str);
					$(".total_price").text(total_price);
					$(".foot_price").text(total_price);
					foot_price=total_price;
				}
			},'json');
				
			$.get('http://39.96.199.148:8060/getUserCoupon',{user_id:user_id},function(res){
				// alert(res.code);
				if(res.code==1){    
					var str="<div class='mui-collapse-content'><p>";
					$.each(res.data,function(i,v){
						if(v.coupon_type==2){
							str+="<div class='mui-input-row mui-radio'>"+  
									"<label>"+v.coupon_name+"</label>"+
									"<input name='uc_id' class='coupon_click'  type='radio' coupon_type='"+v.coupon_type+"' price='"+v.price+"'   value='"+v.uc_id+"'>"+
								"</div>";
						}else if(v.coupon_type==1){
							str+="<div class='mui-input-row mui-radio'>"+  
									"<label>"+v.coupon_name+"</label>"+
									"<input name='uc_id' class='coupon_click' type='radio' coupon_type='"+v.coupon_type+"' max='"+v.max+"'  price='"+v.price+"' value='"+v.uc_id+"'>"+
								"</div>";
						}else{
							str+="<div class='mui-input-row mui-radio'>"+  
									"<label>"+v.coupon_name+"</label>"+
									"<input name='uc_id' class='coupon_click' type='radio' coupon_type='"+v.coupon_type+"' discount='"+v.discount+"' value='"+v.uc_id+"'>"+
								"</div>";
						}
					});
					str+="</p></div>";
					$(".couponInfo").append(str);
					$(".coupon_click").click(function(){
						var _this=$(this);
						var coupon_type=_this.attr('coupon_type')
						if(coupon_type==1){
							var max=parseInt(_this.attr('max'));     
							if(max>total_price){
								alert('不满足使用条件！');
								_this.prop('checked',false);
							}else{
								var price=parseInt(_this.attr('price')).toFixed(2);
								var foot_price=total_price-price;
								$(".zhekou").text(price);
								$(".foot_price").text(foot_price.toFixed(2));
							}
						}else if(coupon_type==2){
							var price=Number(_this.attr('price')).toFixed(2); 
							$(".zhekou").text(price);
							foot_price=Number(total_price)-Number(price);
							foot_price=foot_price.toFixed(2)
							$(".foot_price").text(foot_price);
						}else{
							var discount=Number(_this.attr('discount')).toFixed(2);
							console.log(total_price);
							foot_price=total_price*discount/10; 
							$(".foot_price").text(foot_price.toFixed(2));
							var price=total_price-foot_price;
							$(".zhekou").text(price.toFixed(2));  
						} 
					});
				}else{
					
				}
			},'json');



			$(".jiesuan").click(function(){
				var pay_way=$("[name='pay_way']:checked").val(); 
				var address_id=$("[name='address_id']:checked").val();
				var url="http://39.96.199.148:8060/createOrder";
				if($(".address_info").hasClass('none')){
					mui.alert('您还未设置收货地址，点击去设置！','提示',function(){
						mui.openWindow({
							url:'address.html', 
							createNew:true,
							extras:{ 
								cart_id:cart_id
							}
						});
					});
					return false;
				}else{
					if(address_id==undefined){ 
						mui.alert('您还未设置收货地址，点击去设置！','提示',function(){
							mui.openWindow({
								url:'add-address.html', 
								createNew:true,
								extras:{ 
									cart_id:cart_id
								}
							});
						});
						return false;
					}
				}
				
				var total=foot_price;
				var data={};
				data.cart_id=cart_id;
				data.pay_way=pay_way;
				data.address_id=address_id;
				data.user_id=user_id;
				data.total=total;  
				console.log(address_id);
				return 
				false;
				$.post(url,data,function(res){
					alert(res.msg); 
					if(res.code==1){ 
						mui.openWindow({
							url:'success.html', 
							createNew:true, 
							extras:{ 
								order_id:res.order_id
							}
						});
					}
				},'json');
			});
			
		});
	})
</script>